var ue=Object.defineProperty,de=Object.defineProperties;var he=Object.getOwnPropertyDescriptors;var S=Object.getOwnPropertySymbols;var X=Object.prototype.hasOwnProperty,Z=Object.prototype.propertyIsEnumerable;var V=(e,n,t)=>n in e?ue(e,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):e[n]=t,m=(e,n)=>{for(var t in n||(n={}))X.call(n,t)&&V(e,t,n[t]);if(S)for(var t of S(n))Z.call(n,t)&&V(e,t,n[t]);return e},x=(e,n)=>de(e,he(n));var G=(e,n)=>{var t={};for(var a in e)X.call(e,a)&&n.indexOf(a)<0&&(t[a]=e[a]);if(e!=null&&S)for(var a of S(e))n.indexOf(a)<0&&Z.call(e,a)&&(t[a]=e[a]);return t};import{cT as ge,dA as pe,r as l,j as s,a as d,p as R,K as Q,i as A,dK as me,du as xe,dt as fe,dn as je,o as ve,cP as W,e as we,aZ as k,dm as _e,aD as ee,S as ye,dT as Te,q as U,dr as be,b9 as $,bg as y,U as Ce,x as Ne,ag as Fe,ah as Me,b6 as Se,aj as ke,dU as ze,bq as Ee,ak as L,br as Be,c as se,dV as Pe,dW as Re,dX as Ae,dY as Ue,$ as H,ac as ne}from"./index-81db420b.js";import{u as Ie,a as $e,b as Le,F as He,C as De,J as Oe,T as qe,c as Ke}from"./TypingIndicator-a31fce65.js";import{M as Ye,U as Je,D as Ve,T as Xe,R as Ze}from"./useCurrentChannelData-5d20df6c.js";import{u as I}from"./EmptyState-0a5144f8.js";const Ge=a=>{var o=a,{message:e,user:n}=o,t=G(o,["message","user"]);var v,p,T,b;const r=ge(e.owner),i=pe(e.owner),h=l.useRef(null),[g,j]=l.useState(!((v=e.text)!=null&&v.length)),[f,z]=l.useState(null);l.useLayoutEffect(()=>{var C,N;z((N=(C=h.current)==null?void 0:C.clientHeight)!=null?N:null)});const E=(f&&f>=40||g)&&e.message_type==="Text";return s.jsxs(d,{gap:"3",pb:"2",pt:"7",className:"bg-white dark:bg-gray-2 border-gray-4 sm:dark:border-gray-6 border-b",children:[s.jsx(Ye,{userID:e.owner,user:r,isActive:i}),s.jsxs(d,{direction:"column",gap:"0.5",justify:"center",width:"100%",children:[s.jsxs(d,{align:"center",gap:"2",mt:"-1",children:[s.jsx(Je,{user:r,userID:e.owner,isActive:i}),s.jsx(Ve,{timestamp:e.creation,timeFormat:"Do MMM [at] hh:mm A"})]}),s.jsxs(R,{children:[s.jsxs(R,x(m({ref:h,className:Q("overflow-y-hidden",g?"max-h-min":"max-h-10")},t),{children:[e.text?s.jsx(Xe,{message:x(m({},e),{message_type:"Text"}),user:n,showMiniImage:!0,showLinkPreview:!1}):null,e.message_type==="Poll"?s.jsxs(A,{as:"span",size:"2",className:"line-clamp-2 flex items-center",children:[s.jsx(me,{size:"14",className:"inline mr-1"}),"Poll: ",(T=(p=e.content)==null?void 0:p.split(`
`))==null?void 0:T[0]]}):["File","Image"].includes((b=e.message_type)!=null?b:"Text")?s.jsxs(d,{gap:"2",align:"center",children:[e.message_type==="File"&&e.file&&s.jsx(xe,{ext:fe(e.file),size:"18"}),e.message_type==="Image"&&s.jsx("img",{src:e.file,alt:`Image sent by ${e.owner}`,height:"30",width:"30",className:"object-cover rounded-md"}),s.jsx(A,{as:"span",size:"2",children:je(e.file)})]}):null]})),E&&s.jsxs(ve,{size:"1",color:"gray",variant:"ghost",className:"hover:bg-transparent hover:underline cursor-pointer mt-0.5",onClick:()=>j(!g),children:["Show ",g?"Less":"More"]})]})]})]})},We=({channelID:e})=>{const[n,t]=l.useState(""),[a,o]=l.useState(!1);return W("ai_event",r=>{r.channel_id===e&&(t(r.text),o(!0))}),W("ai_event_clear",r=>{r.channel_id===e&&t("")}),l.useEffect(()=>{n||setTimeout(()=>{o(!1)},300)},[n]),s.jsx("div",{className:Q("w-full transition-all duration-300 ease-ease-out-quart",a?"translate-y-0 opacity-100 z-50 sm:pb-0 pb-16":"translate-y-full opacity-0 h-0"),children:s.jsxs("div",{className:"flex items-center gap-2 py-2 px-2 bg-white dark:bg-gray-2",children:[s.jsx(we,{}),s.jsx(A,{size:"2",children:n})]})})},os=({threadMessage:e})=>{const n=e.name,t=e.channel_id,{channelMembers:a}=I(t!=null?t:""),{stopTyping:o,onUserType:r}=Ie(n!=null?n:""),[i,h]=l.useState(null),g=c=>{h(c)},j=()=>{h(null)},f=l.useRef(null),{mutate:z}=k(),E=c=>{z({path:`get_messages_for_channel_${n}`},u=>{var Y,J;if(u&&(u!=null&&u.message.has_new_messages))return u;const w=(Y=u==null?void 0:u.message.messages)!=null?Y:[],P=[...w];return c.forEach(_=>{const M=w.findIndex(ce=>ce.name===_.name);M!==-1?P[M]=x(m({},_),{_liked_by:"",is_pinned:0,is_continuation:0}):P.push(x(m({},_),{_liked_by:"",is_pinned:0,is_continuation:0}))}),{message:{messages:P.sort((_,M)=>new Date(M.creation).getTime()-new Date(_.creation).getTime()),has_new_messages:!1,has_old_messages:(J=u==null?void 0:u.message.has_old_messages)!=null?J:!1}}},{revalidate:!1}).then(()=>{var u,w;(w=f.current)==null||w.scrollTo(0,(u=f.current)==null?void 0:u.scrollHeight)}),o(),j()},{fileInputRef:v,files:p,setFiles:T,removeFile:b,uploadFiles:C,addFile:N,fileUploadProgress:te}=$e(n!=null?n:""),{sendMessage:ae,loading:re}=Le(n!=null?n:"",C,E,i),D=l.useRef(null),ie=l.useCallback(()=>{var c;(c=D.current)==null||c.onUpArrow()},[]),O=l.useRef(null),q=_e(),oe=l.useCallback(()=>{var c;q||(c=O.current)==null||c.focusEditor()},[q]),le=({selectedMessage:c})=>c?s.jsx(Ze,{justify:"between",align:"center",className:"m-2",message:c,children:s.jsx(U,{color:"gray",size:"1",className:"z-50",variant:"soft",onClick:j,children:s.jsx(be,{size:"20"})})}):null,{name:F}=ee(),{channelMembers:B}=I(n!=null?n:""),K=l.useMemo(()=>F&&B?F in B:!1,[F,B]);return s.jsx(d,{direction:"column",justify:"between",gap:"0",className:"h-full p-4",children:s.jsxs(He,{files:p,areaHeight:"h-[calc(100vh-72px)]",height:"100%",width:"w-[calc((100vw-var(--sidebar-width)-var(--space-8)-var(--space-5))/2)]",ref:v,onFileChange:T,maxFiles:10,maxFileSize:1e7,children:[s.jsx(Ge,{message:e}),s.jsx(De,{channelID:n!=null?n:"",scrollRef:f,ref:D,replyToMessage:g,showThreadButton:!1,onModalClose:oe}),s.jsx(We,{channelID:n!=null?n:""}),!K&&s.jsx(Oe,{user:F}),K&&s.jsxs(ye,{children:[s.jsx(qe,{channel:n!=null?n:""}),s.jsx(Ke,{channelID:n,fileProps:{fileInputRef:v,addFile:N},ref:O,onUpArrow:ie,onUserType:r,channelMembers:a,clearReplyMessage:j,replyMessage:i,sessionStorageKey:`tiptap-${n}`,onMessageSend:ae,messageSending:re,slotBefore:s.jsxs(d,{direction:"column",justify:"center",hidden:!i&&!p.length,children:[i&&s.jsx(le,{selectedMessage:i}),p&&p.length>0&&s.jsx(d,{gap:"2",width:"100%",align:"end",px:"2",p:"2",wrap:"wrap",children:p.map(c=>s.jsx(R,{className:"grow-0",children:s.jsx(Te,{file:c,uploadProgress:te,removeFile:()=>b(c.fileID)})},c.fileID))})]})},n)]})]})})},ls=()=>{const e=$(),{threadID:n}=y(),{name:t}=ee(),{channelMembers:a}=I(n!=null?n:""),{currentUser:o}=l.useContext(Ce),r=l.useMemo(()=>{var i;return t&&a&&(i=a[t])!=null?i:null},[t,a]);return s.jsx("header",{className:"dark:bg-gray-2 bg-white fixed top-0 px-3 sm:w-[calc((100vw-var(--sidebar-width)-var(--space-8))/2)] w-screen",style:{zIndex:999},children:s.jsx(d,{direction:"column",gap:"2",className:"pt-3",children:s.jsxs(d,{justify:"between",align:"center",children:[s.jsx(Ne,{size:"4",className:"pl-1",children:"Thread"}),s.jsxs(d,{gap:"2",justify:"between",align:"center",className:"px-4 sm:px-0",children:[r&&s.jsxs(Fe,{children:[s.jsx(Me,{children:s.jsx(U,{color:"gray",className:"bg-transparent text-gray-12 hover:bg-gray-3",children:s.jsx(Se,{})})}),s.jsxs(ke,{className:"min-w-48",children:[s.jsx(ss,{channelMember:r}),s.jsx(es,{}),a[o].is_admin===1&&s.jsx(Qe,{})]})]}),s.jsx(U,{className:"mr-1 text-gray-11",variant:"ghost",color:"gray","aria-label":"Close thread",title:"Close thread",onClick:()=>e("../",{replace:!0}),children:s.jsx(ze,{size:"16"})})]})]})})})},Qe=()=>{const{threadID:e}=y(),n=$(),{deleteDoc:t}=Ee(),a=()=>{const o=t("Raven Channel",e).then(()=>(n("../"),Promise.resolve()));H.promise(o,{success:"You have deleted the thread",error:r=>`Could not delete thread - ${ne(r)}`})};return s.jsx(L,{color:"red",onClick:a,children:s.jsxs(d,{gap:"2",align:"center",children:[s.jsx(Be,{size:"16"}),"Delete Thread"]})})},es=()=>{const{threadID:e}=y(),{mutate:n}=k(),t=$(),{call:a}=se("raven.api.raven_channel.leave_channel"),o=()=>{const r=a({channel_id:e}).then(()=>(t("../"),n(["channel_members",e]),Promise.resolve()));H.promise(r,{success:"You have left the thread",error:i=>`Could not leave thread - ${ne(i)}`})};return s.jsx(L,{onClick:o,color:"red",children:s.jsxs(d,{gap:"2",align:"center",children:[s.jsx(Pe,{size:"16"}),"Leave Thread"]})})},ss=({channelMember:e})=>{const{threadID:n}=y(),{mutate:t}=k(),a=Re(),{call:o}=se("raven.api.notification.toggle_push_notification_for_channel"),r=()=>{if(e){const i=o({member:e==null?void 0:e.channel_member_name,allow_notifications:e!=null&&e.allow_notifications?0:1}).then(h=>(h&&h.message&&t(["channel_members",n],g=>({message:x(m({},g.message),{[e.name]:x(m({},g.message[e.name]),{allow_notifications:h.message.allow_notifications})})}),{revalidate:!1}),Promise.resolve()));H.promise(i,{success:"Notification settings updated",error:"Failed to update notification settings"})}};return a?s.jsx(L,{onClick:r,children:s.jsxs(d,{gap:"2",align:"center",children:[e.allow_notifications?s.jsx(Ae,{size:"16"}):s.jsx(Ue,{size:"16"}),e.allow_notifications?"Disable":"Enable"," Notifications"]})}):null},cs=e=>{const{mutate:n}=k(),{workspaceID:t}=y();l.useEffect(()=>{const a=o=>{o&&n(["unread_thread_count",t],r=>{if(r&&r.message){const i=[...r.message],h=i.findIndex(g=>g.name===o);return h!==-1&&i.splice(h,1),{message:i}}return r},{revalidate:!1})};return a(e),()=>{a(e)}},[e,t])};export{ls as T,os as a,cs as u};
