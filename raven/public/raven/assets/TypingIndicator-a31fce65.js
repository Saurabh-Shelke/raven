var As=Object.defineProperty,zs=Object.defineProperties;var Ls=Object.getOwnPropertyDescriptors;var ke=Object.getOwnPropertySymbols;var Ue=Object.prototype.hasOwnProperty,Ve=Object.prototype.propertyIsEnumerable;var He=(s,t,n)=>t in s?As(s,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):s[t]=n,x=(s,t)=>{for(var n in t||(t={}))Ue.call(t,n)&&He(s,n,t[n]);if(ke)for(var n of ke(t))Ve.call(t,n)&&He(s,n,t[n]);return s},z=(s,t)=>zs(s,Ls(t));var K=(s,t)=>{var n={};for(var a in s)Ue.call(s,a)&&t.indexOf(a)<0&&(n[a]=s[a]);if(s!=null&&ke)for(var a of ke(s))t.indexOf(a)<0&&Ve.call(s,a)&&(n[a]=s[a]);return n};var q=(s,t,n)=>new Promise((a,r)=>{var l=d=>{try{o(n.next(d))}catch(f){r(f)}},c=d=>{try{o(n.throw(d))}catch(f){r(f)}},o=d=>d.done?a(d.value):Promise.resolve(d.value).then(l,c);o((n=n.apply(s,t)).next())});import{r as u,n as Ee,$ as X,ac as Bs,j as e,a as _,p as U,a3 as J,b_ as $,q as L,dZ as Ps,d_ as Fs,d$ as Os,J as he,cL as Rs,e0 as $s,e1 as Hs,e2 as Us,e3 as Vs,e4 as Ks,e5 as qs,dE as Ws,aG as fe,dQ as Pe,dA as Ys,K as Z,a0 as Ne,at as ye,i as B,e6 as Gs,b7 as Ae,G as Js,a2 as re,bY as Zs,a6 as ie,a7 as le,aq as xe,ar as je,M as ce,W as as,b9 as Fe,e7 as ue,S as rs,o as W,b8 as is,a4 as ls,e8 as Qs,bB as cs,u as Oe,ae as Re,E as oe,aP as Te,d as we,au as ge,e as V,e9 as Xs,ea as et,am as os,an as ds,ao as st,ap as us,eb as ms,df as tt,ec as nt,dK as at,ed as hs,ee as gs,as as fs,cF as xs,bg as js,dm as ps,aH as rt,c$ as it,cr as lt,c as _e,ef as ct,bq as ot,V as dt,cv as bs,cy as ys,aV as ut,cw as _s,Y as mt,Z as ht,a8 as gt,ab as ft,ad as xt,aQ as ws,dr as $e,dw as Me,dy as De,eg as jt,U as vs,eh as pt,dz as bt,cP as me,bu as Ke,c9 as G,ei as pe,ej as ae,L as yt,b as _t,z as wt,aT as vt,du as Ct,dt as kt,f as St,dn as Nt,bi as Tt,bj as Et,bn as qe,bk as Mt,cT as Dt,aD as It,ek as At,aZ as zt}from"./index-81db420b.js";import{L as Q,U as Cs,P as ks,f as Ie,V as Lt,r as Bt,D as Pt,o as Ft,W as ze,X as Le,c as Ot,x as Rt,a as $t,j as Ht,t as Ut,b as Vt,p as Kt,S as qt,C as Wt,u as Yt,Q as We,Y as Gt,E as Ye,g as Jt}from"./index-a9edd0f4.js";import{S as Zt,b as Ss,c as Qt,H as Xt,L as en,I as sn,d as tn,e as nn,f as an}from"./useCurrentChannelData-5d20df6c.js";/* empty css                      */import{D as rn}from"./DoctypeLinkRenderer-5c845fcf.js";import{E as ln}from"./preferences-0e1c8796.js";import{C as cn}from"./EmptyState-0a5144f8.js";import{D as on}from"./DateSeparator-55fa17c4.js";import{u as dn}from"./useGetUserRecords-beb6efeb.js";function ya(s){const{file:t}=u.useContext(Ee),n=u.useRef(null),[a,r]=u.useState([]),[l,c]=u.useState(!0),o=u.useRef([]);o.current=a;const[d,f]=u.useState({});return{fileInputRef:n,files:a,setFiles:r,removeFile:y=>{let b=a.filter(S=>S.fileID!==y);r(b),f(S=>{const C=x({},S);return delete C[y],C})},addFile:y=>{const b=y;b&&(b.fileID=y.name+Date.now(),b.uploadProgress=0,r(S=>[...S,b]))},compressImages:l,setCompressImages:c,uploadFiles:y=>q(this,null,function*(){const b=[...o.current];if(b.length>0){const S=b.map((C,w)=>q(this,null,function*(){return t.uploadFile(C,{isPrivate:!0,doctype:"Raven Message",otherData:{channelID:s,compressImages:l,is_reply:w===0&&y?1:0,linked_message:w===0&&y?y.name:null},fieldname:"file"},(M,T)=>{const I=Math.round(M/(T!=null?T:C.size)*100);f(P=>z(x({},P),{[C.fileID]:{progress:I,isComplete:!1}}))},"raven.api.upload_file.upload_file_with_message").then(M=>(r(T=>T.filter(I=>I.fileID!==C.fileID)),f(T=>z(x({},T),{[C.fileID]:{progress:100,isComplete:!0}})),M.data.message)).catch(M=>(f(T=>{const I=x({},T);return delete I[C.fileID],I}),X.error("There was an error uploading the file "+C.name,{description:Bs(M)}),null))}));return Promise.all(S).then(C=>(r([]),C.filter(w=>w!==null))).catch(C=>(console.error(C),[]))}else return Promise.resolve([])}),fileUploadProgress:d}}const F={size:"18"},O="bg-transparent dark:text-gray-11 sm:dark:text-gray-10 text-gray-11 hover:bg-accent-a3 hover:text-accent-a11 dark:hover:text-accent-a11",un=s=>e.jsx(_,x({justify:"between",align:"center",className:"border-t border-t-slate-5 bg-slate-2 rounded-b-radius4 overflow-hidden",p:"1"},s)),Ge=u.memo(()=>{const{editor:s}=Q(),t="bg-accent-a3";return s?e.jsxs(_,{gap:"2",align:"center",px:"1",py:"1",className:"sm:max-w-[60%] max-w-[100%] overflow-x-auto",children:[e.jsxs(_,{gap:"3",align:"center",children:[e.jsx(J,{content:$()+" + B","aria-label":$()+" + B",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleBold().run(),"aria-label":"bold",variant:"ghost",title:"Bold",size:"1",className:s.isActive("bold")?t:O,disabled:!s.can().chain().focus().toggleBold().run(),children:e.jsx(Ps,x({},F))})}),e.jsx(J,{content:$()+" + I","aria-label":$()+" + I",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleItalic().run(),"aria-label":"italic",title:"Italic",variant:"ghost",size:"1",className:s.isActive("italic")?t:O,disabled:!s.can().chain().focus().toggleItalic().run(),children:e.jsx(Fs,x({},F))})}),e.jsx(J,{content:$()+" + U","aria-label":$()+" + U",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleUnderline().run(),"aria-label":"underline",title:"Underline",variant:"ghost",size:"1",className:s.isActive("underline")?t:O,disabled:!s.can().chain().focus().toggleUnderline().run(),children:e.jsx(Os,x({},F))})})]}),e.jsx(he,{orientation:"vertical"}),e.jsxs(_,{gap:"3",align:"center",children:[e.jsx(J,{content:$()+" + E","aria-label":$()+" + E",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleCode().run(),"aria-label":"code",variant:"ghost",size:"1",title:"Code",className:s.isActive("code")?t:O,disabled:!s.can().chain().focus().toggleCode().run(),children:e.jsx(Rs,x({},F))})}),e.jsx(J,{content:$()+"+ Shift + E","aria-label":$()+"+ Shift + E",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleCodeBlock().run(),"aria-label":"code block",variant:"ghost",size:"1",title:"Code Block",className:s.isActive("codeBlock")?t:O,disabled:!s.can().chain().focus().toggleCodeBlock().run(),children:e.jsx($s,x({},F))})}),e.jsx(L,{onClick:()=>s.chain().focus().toggleStrike().run(),"aria-label":"strike",variant:"ghost",size:"1",title:"Strike",className:s.isActive("strike")?t:O,disabled:!s.can().chain().focus().toggleStrike().run(),children:e.jsx(Hs,x({},F))}),e.jsx(L,{onClick:()=>s.chain().focus().toggleBlockquote().run(),"aria-label":"blockquote",className:s.isActive("blockquote")?t:O,title:"Blockquote",size:"1",variant:"ghost",disabled:!s.can().chain().focus().toggleBlockquote().run(),children:e.jsx(Us,x({},F))})]}),e.jsx(he,{orientation:"vertical"}),e.jsxs(_,{gap:"3",align:"center",children:[e.jsx(J,{content:$()+" + Shift + 7","aria-label":$()+" + Shift + 7",children:e.jsx(L,{onClick:()=>s.chain().focus().toggleOrderedList().run(),"aria-label":"ordered list",title:"Ordered List",size:"1",variant:"ghost",className:s.isActive("orderedList")?t:O,disabled:!s.can().chain().focus().toggleOrderedList().run(),children:e.jsx(Vs,x({},F))})}),e.jsx(J,{content:$()+" + Shift + 8","aria-label":$()+" + Shift + 8",children:e.jsx(L,{onClick:()=>s.chain().focus().liftEmptyBlock().toggleBulletList().run(),"aria-label":"bullet list",title:"Bullet List",size:"1",variant:"ghost",className:s.isActive("bulletList")?t:O,disabled:!s.can().chain().focus().toggleBulletList().run(),children:e.jsx(Ks,x({},F))})})]}),e.jsx(he,{orientation:"vertical"}),e.jsx(_,{gap:"3",align:"center",children:e.jsx(J,{content:$()+" + Shift + H","aria-label":$()+" + Shift + H",children:e.jsx(L,{"aria-label":"highlight",onClick:()=>s.chain().focus().toggleHighlight().run(),title:"Highlight",variant:"ghost",size:"1",className:s.isActive("highlight")?t:O,disabled:!s.can().chain().focus().toggleHighlight().run(),children:e.jsx(qs,x({},F))})})}),e.jsx(mn,{})]}):e.jsx(U,{})}),mn=()=>{const{editor:s}=Q(),t=a=>q(void 0,null,function*(){let r=a;const c=(yield fe(()=>import("./index-d1ab2363.js"),["assets/index-d1ab2363.js","assets/index-81db420b.js","assets/index-27ae9ec0.css"])).parse(r,void 0,{forwardDate:!0});return c.sort((o,d)=>d.index-o.index),c.forEach(o=>{var S,C,w,M;if(!o.start.isCertain("hour")&&!o.start.isCertain("minute")&&!o.start.isCertain("day"))return;const d=o.start.isCertain("hour")&&o.start.isCertain("minute"),f=o.start.date().getTime(),k=(C=(S=o.end)==null?void 0:S.date().getTime())!=null?C:null,N=k?((w=o.end)==null?void 0:w.isCertain("hour"))&&((M=o.end)==null?void 0:M.isCertain("minute")):!1,v=o.index,y=o.text;let b="";f&&(b+=`data-timestamp-start="${f}"`),k&&(b+=` data-timestamp-end="${k}"`),d||(b+=' data-timestamp-start-all-day="true"'),N||(b+=' data-timestamp-end-all-day="true"'),r=r.slice(0,v)+`<span class="timestamp" ${b}">${y}</span>`+r.slice(v+y.length)}),r}),n=()=>q(void 0,null,function*(){if(s){const{from:a,to:r,replaceWith:l,empty:c}=s.state.selection;if(c){const o=s.getHTML(),d=yield t(o);s.chain().focus().setContent(d).run()}else{const o=s.view.state.doc.textBetween(a,r," "),d=yield t(o);s.chain().focus().deleteSelection().insertContent(d).run()}}});return s?e.jsx(_,{gap:"3",align:"center",children:e.jsx(L,{"aria-label":"Parse timestamps from message",onClick:n,title:"Parse timestamps from message",variant:"ghost",size:"1",className:O,disabled:!s.can().chain().focus().run(),children:e.jsx(Ws,x({},F))})}):e.jsx(U,{})},hn=Cs.create({name:"placeholder",addOptions(){return{emptyEditorClass:"is-editor-empty",emptyNodeClass:"is-empty",placeholder:"Write something â€¦",showOnlyWhenEditable:!0,showOnlyCurrent:!0,includeChildren:!1}},addProseMirrorPlugins(){return[new ks({key:new Ie("placeholder"),props:{decorations:({doc:s,selection:t})=>{const n=this.editor.isEditable||!this.options.showOnlyWhenEditable,{anchor:a}=t,r=[];if(!n)return null;const l=this.editor.isEmpty;return s.descendants((c,o)=>{const d=a>=o&&a<=o+c.nodeSize,f=!c.isLeaf&&Lt(c);if((d||!this.options.showOnlyCurrent)&&f){const k=[this.options.emptyNodeClass];l&&k.push(this.options.emptyEditorClass);const N=Bt.node(o,o+c.nodeSize,{class:k.join(" "),"data-placeholder":typeof this.options.placeholder=="function"?this.options.placeholder({editor:this.editor,node:c,pos:o,hasAnchor:d}):this.options.placeholder});r.push(N)}return this.options.includeChildren}),Pt.create(s,r)}}})]}}),gn=u.forwardRef((s,t)=>{const[n,a]=u.useState(0),r=d=>{const f=s==null?void 0:s.items[d];f&&s.command({id:f.name,label:f.full_name})},l=()=>{a((n+(s==null?void 0:s.items.length)-1)%(s==null?void 0:s.items.length))},c=()=>{a((n+1)%(s==null?void 0:s.items.length))},o=()=>{r(n)};return u.useEffect(()=>a(0),[s==null?void 0:s.items]),u.useImperativeHandle(t,()=>({onKeyDown:({event:d})=>d.key==="ArrowUp"?(l(),!0):d.key==="ArrowDown"?(c(),!0):d.key==="Enter"?(o(),!0):!1})),e.jsx(Pe,{accentColor:"iris",panelBackground:"translucent",children:e.jsx(_,{direction:"column",gap:"0",className:"shadow-lg dark:bg-panel-solid bg-white overflow-y-scroll max-h-96 rounded-md",children:s!=null&&s.items.length?s.items.map((d,f)=>e.jsx(fn,{item:d,index:f,selectItem:r,selectedIndex:n,itemsLength:s.items.length},d.name)):e.jsx("div",{className:"item",children:"No result"})})})}),fn=({item:s,index:t,selectItem:n,selectedIndex:a,itemsLength:r})=>{const l=Ys(s.name),c=u.useRef(null);return u.useEffect(()=>{var o;t===a&&((o=c.current)==null||o.scrollIntoView({block:"nearest"}))},[a,t]),e.jsxs(_,{role:"button",ref:c,align:"center",title:s.full_name,"aria-label":`Mention ${s.full_name}`,className:Z("px-3 py-1.5 gap-2 rounded-md",t===r-1?"rounded-b-md":"rounded-b-none",t===0?"rounded-t-md":"rounded-t-none",t===a?"bg-accent-a5":"bg-panel-translucent"),onClick:()=>n(t),children:[e.jsx(Ne,{src:s.user_image,alt:s.full_name,loading:"lazy",variant:"solid",radius:"full",isActive:l,availabilityStatus:s.availability_status}),e.jsxs(ye,{width:"100%",justify:"between",align:"center",gap:"2",children:[e.jsxs(B,{as:"span",weight:"medium",size:"2",children:[" ",s.full_name]}),e.jsx(B,{as:"span",color:"gray",children:!s.is_member&&e.jsx(Gs,{title:"This user is not a member of the channel"})})]})]},t)},xn=u.forwardRef((s,t)=>{const[n,a]=u.useState(0),r=d=>{const f=s==null?void 0:s.items[d];f&&s.command({id:f.name,label:f.channel_name})},l=()=>{a((n+(s==null?void 0:s.items.length)-1)%(s==null?void 0:s.items.length))},c=()=>{a((n+1)%(s==null?void 0:s.items.length))},o=()=>{r(n)};return u.useEffect(()=>a(0),[s==null?void 0:s.items]),u.useImperativeHandle(t,()=>({onKeyDown:({event:d})=>d.key==="ArrowUp"?(l(),!0):d.key==="ArrowDown"?(c(),!0):d.key==="Enter"?(o(),!0):!1})),e.jsx(Pe,{accentColor:"iris",panelBackground:"translucent",children:e.jsx(_,{direction:"column",gap:"0",className:"shadow-lg dark:bg-panel-solid bg-white overflow-y-scroll max-h-64 rounded-md",children:s!=null&&s.items.length?s.items.map((d,f)=>e.jsx(jn,{item:d,index:f,selectItem:r,selectedIndex:n,itemsLength:s.items.length},d.name)):e.jsx("div",{className:"item",children:"No result"})})})}),jn=({item:s,index:t,selectItem:n,selectedIndex:a,itemsLength:r})=>{const l=u.useRef(null);return u.useEffect(()=>{var c;t===a&&((c=l.current)==null||c.scrollIntoView({block:"nearest"}))},[a,t]),e.jsxs(_,{role:"button",align:"center",ref:l,title:s.channel_name,"aria-label":`Mention channel ${s.channel_name}`,className:Z("px-3 py-2 gap-2 rounded-md",t===r-1?"rounded-b-md":"rounded-b-none",t===0?"rounded-t-md":"rounded-t-none",t===a?"bg-accent-a5":"bg-panel-translucent"),onClick:()=>n(t),children:[e.jsx(Ae,{type:s.type,size:"18"}),e.jsxs(B,{as:"span",weight:"medium",size:"2",children:[" ",s.channel_name]})]},t)};function pn(s){return Js({tag:"svg",attr:{fill:"none",viewBox:"0 0 24 24",strokeWidth:"1.5",stroke:"currentColor","aria-hidden":"true"},child:[{tag:"path",attr:{strokeLinecap:"round",strokeLinejoin:"round",d:"M12.75 8.25v7.5m6-7.5h-3V12m0 0v3.75m0-3.75H18M9.75 9.348c-1.03-1.464-2.698-1.464-3.728 0-1.03 1.465-1.03 3.84 0 5.304 1.03 1.464 2.699 1.464 3.728 0V12h-1.5M4.5 19.5h15a2.25 2.25 0 0 0 2.25-2.25V6.75A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25v10.5A2.25 2.25 0 0 0 4.5 19.5Z"},child:[]}]})(s)}const bn=()=>{const{editor:s}=Q(),[t,n]=u.useState(!1);return u.useEffect(()=>{const a=r=>{r.key==="k"&&(r.metaKey||r.ctrlKey)&&r.shiftKey&&(r.preventDefault(),n(l=>!l))};return document.addEventListener("keydown",a),()=>document.removeEventListener("keydown",a)},[]),s?e.jsxs(re,{open:t,onOpenChange:n,children:[e.jsx(J,{content:`Insert a command (${$()} + Shift + K)`,children:e.jsx(L,{size:"1",variant:"ghost",className:O,onClick:()=>n(!0),title:"Insert a Command","aria-label":"insert a command",children:e.jsx(Zs,x({},F))})}),e.jsxs(ie,{className:le,children:[e.jsx(xe,{children:"Insert a command"}),e.jsx(je,{size:"2",children:"Select a saved command to insert into your message."}),e.jsx(yn,{onClose:()=>n(!1)})]})]}):null},yn=({onClose:s})=>{const{editor:t}=Q(),n=ce(),{data:a,isLoading:r}=as("raven.api.ai_features.get_saved_prompts",{}),l=Fe();return e.jsxs(ue,{label:"Global Command Menu",className:"command-menu",children:[e.jsx(ue.Input,{autoFocus:n,className:"ml-0 my-2 text-base italic",placeholder:"Search saved prompts"}),e.jsxs(ue.List,{children:[e.jsx(ue.Empty,{className:"py-4",children:e.jsxs(rs,{align:"center",justify:"center",gap:"2",children:[e.jsx(B,{size:"2",color:"gray",weight:"medium",children:"No saved prompts found"}),e.jsx(U,{children:e.jsx(W,{className:"not-cal",variant:"soft",onClick:()=>l("/settings/commands"),children:"Create"})})]})}),r&&e.jsx(ue.Loading,{children:"Loading..."}),a==null?void 0:a.message.map(c=>e.jsx(ue.Item,{onSelect:()=>{t==null||t.chain().focus().insertContent(c.prompt).run(),s()},keywords:[c.prompt],value:c.prompt,children:c.prompt},c.name))]})]})},Ns=()=>({recentlyUsedDoctypes:u.useMemo(()=>{var a;const n=(a=sessionStorage.getItem("recently-used-doctype"))!=null?a:"[]";return JSON.parse(n).map(r=>({value:r,description:"Recently used"}))},[]),addRecentlyUsedDocType:n=>{var l;const a=(l=sessionStorage.getItem("recently-used-doctype"))!=null?l:"[]";let r=JSON.parse(a);r.includes(n)||(r=[n,...r].slice(0,5)),sessionStorage.setItem("recently-used-doctype",JSON.stringify(r))}}),_n=({channelID:s})=>{const[t,{off:n},a]=is();return e.jsxs(re,{open:t,onOpenChange:a,children:[e.jsx(J,{content:"Attach a document from the system",children:e.jsx(ls,{children:e.jsx(L,{"aria-label":"Attach a document from the system",variant:"ghost",className:O,size:"1",title:"Attach a document from the system",children:e.jsx(Qs,x({},F))})})}),e.jsxs(ie,{className:Z(le,"static"),children:[e.jsx(xe,{className:"mb-1",children:"Send a document"}),e.jsx(je,{size:"2",children:"Choose a document from the system to send."}),e.jsx(wn,{channelID:s,onClose:n})]})]})},wn=({channelID:s,onClose:t})=>{var b,S;const{loading:n,error:a,createDoc:r}=cs(),l=Oe(),{watch:c}=l,o=()=>{l.reset(),t()},d=c("doctype"),f=c("docname"),{recentlyUsedDoctypes:k,addRecentlyUsedDocType:N}=Ns(),v=C=>{N(C.doctype),r("Raven Message",{message_type:"Text",channel_id:s,link_doctype:C.doctype,link_document:C.docname}).then(()=>{o()})},y=()=>{l.setValue("docname","")};return e.jsx("form",{className:"pt-2",onSubmit:l.handleSubmit(v),children:e.jsx(Re,z(x({},l),{children:e.jsxs(rs,{gap:"2",children:[a&&e.jsx(oe,{error:a}),e.jsx(U,{width:"100%",children:e.jsxs(_,{direction:"column",gap:"2",children:[e.jsx(Te,{name:"doctype",label:"Document Type",autofocus:!0,suggestedItems:k,required:!0,rules:{required:"Document Type is required",onChange:y},filters:[["issingle","=",0],["istable","=",0]],doctype:"DocType"}),e.jsx(we,{children:(b=l.formState.errors.doctype)==null?void 0:b.message})]})}),d&&e.jsx(U,{width:"100%",children:e.jsxs(_,{direction:"column",gap:"2",children:[e.jsx(Te,{name:"docname",required:!0,label:"Document Name",placeholder:"Select a document",disabled:!d,rules:{required:"Document Name is required"},doctype:d}),e.jsx(we,{children:(S=l.formState.errors.docname)==null?void 0:S.message})]})}),e.jsx("div",{className:Z("transition-all duration-500",f?"opacity-100":"opacity-0"),children:d&&f&&e.jsx(rn,{doctype:d,docname:f})}),e.jsxs(_,{gap:"3",mt:"6",justify:"end",align:"center",children:[e.jsx(ge,{disabled:n,children:e.jsx(W,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsxs(W,{type:"button",disabled:n,onClick:l.handleSubmit(v),children:[n&&e.jsx(V,{className:"text-white"}),"Send"]})]})]})}))})},vn=u.lazy(()=>fe(()=>import("./EmojiPicker-289a24eb.js"),["assets/EmojiPicker-289a24eb.js","assets/index-81db420b.js","assets/index-27ae9ec0.css","assets/AddCustomEmojiDialog-15ed8490.js"])),Cn=u.lazy(()=>fe(()=>import("./CreatePoll-aa138c49.js"),["assets/CreatePoll-aa138c49.js","assets/index-81db420b.js","assets/index-27ae9ec0.css"])),kn=u.lazy(()=>fe(()=>import("./GIFPicker-8af1f178.js"),["assets/GIFPicker-8af1f178.js","assets/index-81db420b.js","assets/index-27ae9ec0.css","assets/useDebounce-02f398f3.js","assets/Skeleton-9de30e70.js"])),Sn=r=>{var l=r,{fileProps:s,channelID:t,isEdit:n}=l,a=K(l,["fileProps","channelID","isEdit"]);return e.jsxs(_,{gap:"2",align:"center",px:"1",py:"1",children:[e.jsxs(_,{gap:"3",align:"center",children:[!n&&t&&e.jsx(_n,{channelID:t}),e.jsx(Nn,{})]}),e.jsx(he,{orientation:"vertical"}),e.jsxs(_,{gap:"3",align:"center",children:[e.jsx(bn,{}),t&&e.jsx(Dn,{channelID:t})]}),e.jsx(he,{orientation:"vertical"}),e.jsxs(_,{gap:"3",align:"center",children:[e.jsx(Tn,{}),e.jsx(En,{}),s&&e.jsx(Mn,{fileProps:s}),e.jsx(Ts,x({},a))]})]})},Nn=()=>{const{editor:s}=Q();return s?e.jsxs(_,{gap:"3",children:[e.jsx(L,{onClick:()=>s.chain().focus().insertContent("#").run(),"aria-label":"mention channel",title:"Mention a channel",className:O,variant:"ghost",size:"1",disabled:!s.can().chain().focus().insertContent("#").run()||!s.isEditable,children:e.jsx(Xs,x({},F))}),e.jsx(L,{onClick:()=>s.chain().focus().insertContent("@").run(),"aria-label":"mention user",variant:"ghost",className:O,size:"1",title:"Mention a user",disabled:!s.can().chain().focus().insertContent("@").run()||!s.isEditable,children:e.jsx(et,x({},F))})]}):null},Tn=()=>{const{editor:s}=Q();if(!s)return null;const t=(n,a,r)=>{a?s.chain().focus().setImage({src:n,alt:r,title:r}).run():s.chain().focus().insertContent(n).run()};return e.jsxs(os,{children:[e.jsx(ds,{children:e.jsx(L,{size:"1",variant:"ghost",className:O,title:"Add emoji",disabled:!s.can().chain().focus().insertContent("ðŸ˜…").run()||!s.isEditable,"aria-label":"add emoji",children:e.jsx(st,x({},F))})}),e.jsx(us,{children:e.jsx(ms,{children:e.jsx(u.Suspense,{fallback:e.jsx(V,{}),children:e.jsx(vn,{onSelect:t,allowCustomEmojis:!1})})})})]})},En=()=>{const{editor:s}=Q();return s?e.jsxs(os,{children:[e.jsx(ds,{children:e.jsx(L,{size:"1",variant:"ghost",className:O,title:"Add GIF","aria-label":"add GIF",children:e.jsx(pn,x({},F))})}),e.jsx(us,{children:e.jsx(ms,{children:e.jsx(u.Suspense,{fallback:e.jsx(V,{}),children:e.jsx(kn,{onSelect:t=>s.chain().focus().setImage({src:t.media_formats.gif.url}).setHardBreak().run()})})})})]}):null},Mn=({fileProps:s})=>{const{editor:t}=Q(),n=()=>{var a,r;(a=s.fileInputRef)!=null&&a.current&&((r=s.fileInputRef)==null||r.current.openFileInput())};return e.jsx(L,{size:"1",onClick:n,variant:"ghost",className:O,disabled:(t==null?void 0:t.isEditable)===!1,title:"Attach file","aria-label":"attach file",children:e.jsx(tt,x({},F))})},Ts=r=>{var l=r,{sendMessage:s,messageSending:t,setContent:n}=l,a=K(l,["sendMessage","messageSending","setContent"]);const{editor:c}=Q(),o=()=>{if(c){const d=c.getText().trim().length>0,f=c.getHTML().includes("img");let k="",N={};if(d||f){N=c.getJSON();const v=N.content;for(let y=v.length-1;y>=0&&(v[y].type==="paragraph"&&(!v[y].content||v[y].content.length===0));y--)v.pop();N.content=v,c.commands.setContent(N),k=c.getHTML()}c.setEditable(!1),s(k,N).then(()=>{n(""),c.chain().focus().clearContent(!0).run(),c.setEditable(!0)}).catch(()=>{c.setEditable(!0)})}};return e.jsx(L,z(x({"aria-label":"send message",title:"Send message",variant:"ghost",size:"1",onClick:o},a),{children:t?e.jsx(V,{}):e.jsx(nt,x({},F))}))},Dn=({channelID:s})=>{const[t,,n]=is(!1),{editor:a}=Q();return e.jsxs(re,{open:t,onOpenChange:n,children:[e.jsx(ls,{children:e.jsx(L,{size:"1",variant:"ghost",className:O,disabled:(a==null?void 0:a.isEditable)===!1,title:"Create Poll","aria-label":"create poll",children:e.jsx(at,{})})}),e.jsxs(ie,{className:le,children:[e.jsx(xe,{children:"Create Poll"}),e.jsx(je,{size:"2",children:"Create a quick poll to get everyone's thoughts on a topic."}),e.jsx(u.Suspense,{fallback:e.jsx(V,{}),children:e.jsx(Cn,{channelID:s,setIsOpen:n})})]})]})},In=u.forwardRef((s,t)=>{const[n,a]=u.useState(0),r=d=>{const f=s==null?void 0:s.items[d];f&&s.command(f)},l=()=>{a((n+(s==null?void 0:s.items.length)-1)%(s==null?void 0:s.items.length))},c=()=>{a((n+1)%(s==null?void 0:s.items.length))},o=()=>{r(n)};return u.useEffect(()=>a(0),[s==null?void 0:s.items]),u.useImperativeHandle(t,()=>({onKeyDown:({event:d})=>d.key==="ArrowUp"?(l(),!0):d.key==="ArrowDown"?(c(),!0):d.key==="Enter"?(o(),!0):!1})),e.jsx(Pe,{accentColor:"iris",panelBackground:"translucent",children:e.jsx(_,{direction:"column",gap:"0",className:"shadow-lg dark:bg-panel-solid bg-white overflow-y-scroll max-h-96 rounded-md",children:s!=null&&s.items.length?s.items.map((d,f)=>{var k;return e.jsx(An,{item:d,index:f,selectItem:r,selectedIndex:n,itemsLength:s.items.length},(k=d.shortcodes)!=null?k:d.id)}):null})})}),An=({item:s,index:t,selectItem:n,selectedIndex:a,itemsLength:r})=>{var c;const l=u.useRef(null);return u.useEffect(()=>{var o;t===a&&((o=l.current)==null||o.scrollIntoView({block:"nearest"}))},[a,t]),e.jsx(_,{role:"button",ref:l,align:"center",title:s.id,"aria-label":`Select emoji ${s.id}`,className:Z("px-3 py-1.5 gap-2 rounded-md cursor-pointer",t===r-1?"rounded-b-md":"rounded-b-none",t===0?"rounded-t-md":"rounded-t-none",t===a?"bg-accent-a5":"bg-panel-translucent"),onClick:()=>n(t),children:e.jsxs(B,{as:"span",weight:"medium",size:"2",children:[e.jsx("em-emoji",{shortcodes:s.shortcodes})," ",(c=s.shortcodes)!=null?c:s.id]})},t)};function zn(s,t=10){return q(this,null,function*(){const n=yield gs.search(s,{maxResults:t,caller:void 0}),a=[];return n.forEach(r=>{r&&r.skins[0].native&&a.push({shortcodes:r.skins[0].shortcodes,emoji:r.skins[0].native,name:r.name,id:r.id})}),a})}function Ln(s=10){const t=hs.get({maxFrequentRows:1,perLine:s}),n=[];return t.forEach(a=>{const r=gs.get(a);r&&r.skins[0].native&&n.push({id:r.id,shortcodes:r.skins[0].shortcodes,emoji:r.skins[0].native,name:r.name})}),n}const Bn=Ft.create({name:"emoji",group:"inline",pluginKey:new Ie("emojiSuggestion"),inline:!0,selectable:!1,atom:!0,addProseMirrorPlugins(){return[Zt({editor:this.editor,char:":",allowedPrefixes:null,items:s=>s.query.length!==0?zn(s.query):Ln(),render:()=>{let s,t;return{onStart:n=>{s=new ze(In,{props:n,editor:n.editor}),n.clientRect&&(t=Le("body",{getReferenceClientRect:n.clientRect,appendTo:()=>document.body,content:s.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start"}))},onUpdate(n){s.updateProps(n),n.clientRect&&t[0].setProps({getReferenceClientRect:n.clientRect})},onKeyDown(n){var a;return n.event.key==="Escape"?(t[0].hide(),!0):(a=s.ref)==null?void 0:a.onKeyDown(n)},onExit(){t[0].destroy(),s.destroy()}}},command:({editor:s,range:t,props:n})=>{var a;s.chain().focus().deleteRange(t).insertContent(n.emoji).run(),hs.add(n.id),(a=window.getSelection())==null||a.collapseToEnd()}})]}}),Pn=u.lazy(()=>fe(()=>import("./MobileInputActions-4a5b31ce.js"),["assets/MobileInputActions-4a5b31ce.js","assets/index-81db420b.js","assets/index-27ae9ec0.css","assets/index-a9edd0f4.js","assets/useCurrentChannelData-5d20df6c.js","assets/useGetUserRecords-beb6efeb.js","assets/useRavenSettings-a6b6461e.js","assets/preferences-0e1c8796.js","assets/DoctypeLinkRenderer-5c845fcf.js","assets/useDoctypeMeta-749cfb81.js","assets/useDebounce-02f398f3.js","assets/useCurrentChannelData-b08321ce.css","assets/EmptyState-0a5144f8.js","assets/DateSeparator-55fa17c4.js","assets/tiptap-8b80dc76.css"])),de=Ot(Jt);de.register("html",Rt);de.register("css",$t);de.register("js",Ht);de.register("ts",Ut);de.register("json",Vt);de.register("python",Kt);const Es=Ss.extend({name:"userMention"}).configure({suggestion:{char:"@",pluginKey:new Ie("userMention"),allowedPrefixes:null,allow:s=>{const t=s.state.doc.textBetween(s.range.from-1,s.range.from,"");return!/[a-zA-Z0-9]/.test(t)}}}),Ms=Ss.extend({name:"channelMention"}).configure({suggestion:{char:"#",pluginKey:new Ie("channelMention"),allowedPrefixes:null,allow:s=>{const t=s.state.doc.textBetween(s.range.from-1,s.range.from,"");return!/[a-zA-Z0-9]/.test(t)}}}),Fn=u.forwardRef(({isEdit:s,slotBefore:t,fileProps:n,onMessageSend:a,onUpArrow:r,channelMembers:l,onUserType:c,channelID:o,replyMessage:d,clearReplyMessage:f,placeholder:k="Type a message...",messageSending:N,sessionStorageKey:v="tiptap-editor",disableSessionStorage:y=!1,defaultText:b=""},S)=>{const{enabledUsers:C}=u.useContext(fs),w=u.useRef([]);u.useEffect(()=>{l?w.current=C.map(i=>z(x({},i),{is_member:i.name in l})).sort((i,h)=>i.is_member?-1:1):w.current=C.map(i=>z(x({},i),{is_member:!0}))},[l,C]);const{channels:M}=u.useContext(xs),{workspaceID:T}=js(),I=ps(),[P]=rt(ln),se=i=>{const h=i.getText().trim().length>0;let g="",j={};return h&&(g=i.getHTML(),j=i.getJSON()),i.setEditable(!1),a(g,j).then(()=>{i.commands.clearContent(!0),i.setEditable(!0),i.commands.focus("start")}).catch(()=>{i.setEditable(!0)}),i.commands.clearContent(!0)},ee=i=>i.commands.first(({commands:h})=>[()=>h.newlineInCode(),()=>h.createParagraphNear(),()=>h.liftEmptyBlock(),()=>h.splitBlock()]),Y=Cs.create({name:"keyboardHandler",addKeyboardShortcuts(){return{Enter:()=>{if(matchMedia("(max-device-width: 768px)").matches||matchMedia("(max-device-width: 1024px)").matches)return!1;const i=this.editor.isActive("codeBlock"),h=this.editor.isActive("listItem");return i||h?!1:P==="send-message"?se(this.editor):ee(this.editor)},"Mod-Enter":()=>{const i=this.editor.isActive("codeBlock"),h=this.editor.isActive("listItem"),g=this.editor.getText().trim().length>0;if(i)return this.editor.commands.newlineInCode();if(h)return!1;if(!i&&!h){let j="",D={};return g&&(j=this.editor.getHTML(),D=this.editor.getJSON()),this.editor.setEditable(!1),a(j,D).then(()=>{this.editor.commands.clearContent(!0),this.editor.setEditable(!0)}).catch(()=>{this.editor.setEditable(!0)}),this.editor.commands.clearContent(!0)}return!1},Backspace:()=>this.editor.isEmpty?(f==null||f(),this.editor.commands.clearContent(!0)):!1,"Shift-Enter":()=>ee(this.editor),ArrowUp:()=>(this.editor.isEmpty&&(r==null||r()),!1)}},addProseMirrorPlugins(){return[new ks({props:{handleDOMEvents:{drop(i,h){if(!(h.dataTransfer&&h.dataTransfer.files&&h.dataTransfer.files.length)||!n)return;const j=Array.from(h.dataTransfer.files).filter(D=>/image/i.test(D.type));j.length!==0&&(h.preventDefault(),j.forEach(D=>{n.addFile(D)}))},paste(i,h){if(!(h.clipboardData&&h.clipboardData.files&&h.clipboardData.files.length)||!n)return;const j=Array.from(h.clipboardData.files).filter(D=>/image/i.test(D.type));j.length!==0&&(h.preventDefault(),j.forEach(D=>{n.addFile(D)}))}}}})]}}),te=[qt.configure({heading:!1,codeBlock:!1,listItem:{HTMLAttributes:{class:"rt-Text text-sm"}},paragraph:{HTMLAttributes:{class:"rt-Text text-sm"}},code:{HTMLAttributes:{class:"pt-0.5 px-1 pb-px bg-[var(--gray-a3)] dark:bg-[#0d0d0d] text-[var(--ruby-a11)] dark-[var(--accent-a3)] text text-xs font-mono rounded border border-gray-4 dark:border-gray-6"}}}),Qt,Xt.configure({multicolor:!0,HTMLAttributes:{class:"bg-[var(--yellow-6)] dark:bg-[var(--yellow-11)] px-2 py-1"}}),en.extend({inclusive:!1}).configure({autolink:!0,protocols:["mailto","https","http"]}),hn.configure({placeholder:k}),Wt.extend({addKeyboardShortcuts(){var i;return z(x({},(i=this.parent)==null?void 0:i.call(this)),{"Mod-Shift-E":()=>this.editor.commands.toggleCodeBlock()})}}).configure({lowlight:de}),sn.configure({inline:!0}),Y,Es.configure({HTMLAttributes:{class:"mention"},renderHTML({options:i,node:h}){var g;return`${i.suggestion.char}${(g=h.attrs.label)!=null?g:h.attrs.id}`},suggestion:{items:i=>w.current.filter(h=>h.full_name.toLowerCase().startsWith(i.query.toLowerCase())).slice(0,10),render:()=>{let i,h;return{onStart:g=>{i=new ze(gn,{props:g,editor:g.editor}),g.clientRect&&(h=Le("body",{getReferenceClientRect:g.clientRect,appendTo:()=>document.body,content:i.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start"}))},onUpdate(g){i.updateProps(g),g.clientRect&&h[0].setProps({getReferenceClientRect:g.clientRect})},onKeyDown(g){var j;return g.event.key==="Escape"?(h[0].hide(),!0):(j=i.ref)==null?void 0:j.onKeyDown(g)},onExit(){h[0].destroy(),i.destroy()}}}}}),Ms.configure({HTMLAttributes:{class:"mention"},renderHTML({options:i,node:h}){var g;return`${i.suggestion.char}${(g=h.attrs.label)!=null?g:h.attrs.id}`},suggestion:{items:i=>M.filter(h=>h.workspace===T&&h.channel_name.toLowerCase().startsWith(i.query.toLowerCase())).slice(0,10),render:()=>{let i,h;return{onStart:g=>{i=new ze(xn,{props:g,editor:g.editor}),g.clientRect&&(h=Le("body",{getReferenceClientRect:g.clientRect,appendTo:()=>document.body,content:i.element,showOnCreate:!0,interactive:!0,trigger:"manual",placement:"bottom-start"}))},onUpdate(g){i.updateProps(g),g.clientRect&&h[0].setProps({getReferenceClientRect:g.clientRect})},onKeyDown(g){var j;return g.event.key==="Escape"?(h[0].hide(),!0):(j=i.ref)==null?void 0:j.onKeyDown(g)},onExit(){h[0].destroy(),i.destroy()}}}}}),Bn,tn],[ne,E]=it(b,v,y),A=ce(),m=Yt({extensions:te,content:ne,editorProps:{handleTextInput(){c==null||c()},attributes:{class:"tiptap-editor"+(d?" replying":"")+(s?" editing-message":"")}},onUpdate({editor:i}){E(i.getHTML())}},[d,c]);return u.useEffect(()=>{(A||s)&&setTimeout(()=>{m==null||m.chain().focus("end").run()},50)},[m,A,s,d]),u.useImperativeHandle(S,()=>({focusEditor:()=>{m==null||m.chain().focus().run()}})),I?e.jsx(U,{className:Z("pt-2 pb-8 w-full bg-white dark:bg-gray-2 z-50 border-t border-t-gray-3 dark:border-t-gray-3",s?"bg-transparent dark:bg-transparent":"fixed bottom-0 left-0 px-4"),children:e.jsxs(We.Provider,{value:{editor:m},children:[t,e.jsxs(_,{align:"end",gap:"2",className:"w-full",children:[!s&&e.jsx("div",{className:"w-8",children:e.jsx(u.Suspense,{fallback:e.jsx(L,{radius:"full",color:"gray",variant:"soft",size:"2",className:"mb-1",children:e.jsx(lt,{size:"20"})}),children:e.jsx(Pn,{fileProps:n,setContent:E,sendMessage:a,messageSending:N,channelID:o})})}),e.jsx(Gt,{tippyOptions:{arrow:!0,offset:[90,15],inlinePositioning:!0},editor:m,children:e.jsx("div",{className:"bg-gray-1 dark:bg-gray-3 shadow-md p-2 rounded-md",children:e.jsx(Ge,{})})}),e.jsxs("div",{className:"border-[1.5px] flex items-end justify-between border-gray-4 rounded-radius2 w-[calc(100vw-72px)] focus-within:border-accent-a8",children:[e.jsx("div",{className:"w-[90%]",children:e.jsx(Ye,{editor:m})}),e.jsx("div",{className:"w-[10%] mb-0.5 flex items-center justify-center h-full",children:e.jsx(Ts,{size:"2",variant:"soft",className:"bg-transparent",sendMessage:a,messageSending:N,setContent:E})})]})]})]})}):e.jsx(U,{className:"border rounded-radius2 border-gray-300 dark:border-gray-500 dark:bg-gray-3",children:e.jsxs(We.Provider,{value:{editor:m},children:[t,e.jsx(Ye,{editor:m}),e.jsxs(un,{children:[e.jsx(Ge,{}),e.jsx(Sn,{fileProps:n,setContent:E,sendMessage:a,messageSending:N,isEdit:s,channelID:o})]})]})})}),On=Object.freeze(Object.defineProperty({__proto__:null,ChannelMention:Ms,UserMention:Es,default:Fn},Symbol.toStringTag,{value:"Module"})),_a=(s,t,n,a)=>{const{call:r,loading:l}=_e("raven.api.raven_message.send_message");return{sendMessage:(o,d)=>q(void 0,null,function*(){return o?r({channel_id:s,text:o,json_content:d,is_reply:a?1:0,linked_message:a?a.name:null}).then(f=>n([f.message])).then(()=>t()).then(f=>{n(f)}):t(a).then(f=>{n(f)})}),loading:l}},wa=u.forwardRef((s,t)=>{const M=s,{files:n,onFileChange:a,maxFiles:r,accept:l,maxFileSize:c,children:o,height:d,width:f,areaHeight:k}=M,N=K(M,["files","onFileChange","maxFiles","accept","maxFileSize","children","height","width","areaHeight"]),[v,y]=u.useState(!1),b=T=>c&&T.size>c*1e6?(X.error(`Uh Oh! ${T.name} exceeded the maximum file size required.`),{code:"size-too-large",message:"File size is larger than the required size."}):null,{getRootProps:S,getInputProps:C,open:w}=ct({onDrop:(T,I)=>{a([...n,...T.map(P=>Object.assign(P,{fileID:P.name+Date.now(),uploadProgress:0}))]),r&&r<I.length&&X.error(`Uh Oh! Maximum ${r} files can be uploaded. Please try again.`)},maxFiles:r||0,accept:l||void 0,validator:b,noClick:!0,noKeyboard:!0,onDragEnter:()=>y(!0),onDragLeave:()=>y(!1),onDropAccepted:()=>y(!1),onDropRejected:()=>y(!1)});return u.useImperativeHandle(t,()=>({openFileInput(){w()}})),e.jsxs(_,z(x(x({direction:"column",style:{height:d!=null?d:"calc(100vh - 80px)"},width:"100%"},S()),N),{children:[o,(r===void 0||n.length<r)&&e.jsxs(_,{align:"center",justify:"center",className:Z("fixed top-14 border-2 border-dashed rounded-md border-gray-6 dark:bg-[#171923AA] bg-[#F7FAFCAA]",k!=null?k:"h-[calc(100vh-72px)]",f!=null?f:"w-[calc(100vw-var(--sidebar-width)-var(--space-8))]"),style:{zIndex:9999},display:v?"flex":"none",children:[e.jsx(B,{as:"span",size:"2",color:"gray",children:"Drop your files here. A Raven will pick it up."}),e.jsx("input",x({type:"file",style:{display:"none"}},C()))]})]}))}),Rn=({onClose:s,message:t})=>{const{deleteDoc:n,error:a,loading:r}=ot(),l=Fe(),c=()=>q(void 0,null,function*(){return n("Raven Message",t.name).then(()=>{X("Message deleted",{duration:800}),t.is_thread&&l(`/channel/${t.channel_id}`),s()})});return e.jsxs(e.Fragment,{children:[e.jsxs(dt,{children:["Delete ",t.is_thread?"Thread":"Message"]}),e.jsxs(_,{direction:"column",gap:"2",children:[e.jsxs(bs,{color:"red",size:"1",children:[e.jsx(ys,{children:e.jsx(ut,{size:"18"})}),e.jsx(_s,{size:"2",children:"This action is permanent and cannot be undone."})]}),e.jsx(oe,{error:a}),t.is_thread?e.jsx(B,{size:"2",children:"This message is a thread, deleting it will delete all messages in the thread."}):e.jsx(B,{size:"2",children:"Are you sure you want to delete this message? It will be deleted for all users."})]}),e.jsxs(_,{gap:"3",mt:"4",justify:"end",children:[e.jsx(mt,{children:e.jsx(W,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsx(ht,{children:e.jsxs(W,{variant:"solid",color:"red",onClick:c,disabled:r,children:[r&&e.jsx(V,{className:"text-white"}),r?"Deleting":"Delete"]})})]})]})},$n=s=>{const[t,n]=u.useState(null),a=u.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setDeleteMessage:n,isOpen:t!==null,onClose:a}},Hn=({message:s,isOpen:t,onClose:n})=>e.jsx(gt,{open:t,onOpenChange:n,children:e.jsx(ft,{className:le,children:s&&e.jsx(Rn,{onClose:n,message:s})})}),Un=u.lazy(()=>fe(()=>Promise.resolve().then(()=>On),void 0)),Je=({onClose:s,message:t})=>{const{updateDoc:n,error:a,loading:r,reset:l}=xt();u.useEffect(()=>{l()},[l]);const c=(o,d)=>q(void 0,null,function*(){return n("Raven Message",t.name,{text:o,json:d}).then(f=>{s(!0),X.info("Message updated")})});return e.jsxs(e.Fragment,{children:[e.jsxs(_,{justify:"between",children:[e.jsx(xe,{children:"Edit Message"}),e.jsx(ws,{children:e.jsx(je,{children:"Type in the new message text"})}),e.jsx(ge,{disabled:r,className:"invisible sm:visible",children:e.jsx(L,{size:"1",variant:"soft",color:"gray",children:e.jsx($e,{size:"18"})})})]}),e.jsxs(_,{gap:"2",direction:"column",children:[e.jsx(oe,{error:a}),e.jsx(u.Suspense,{fallback:e.jsx(V,{}),children:e.jsx(Un,{onMessageSend:c,isEdit:!0,disableSessionStorage:!0,messageSending:r,defaultText:t.text})}),e.jsx(_,{justify:"end",className:"hidden sm:block",children:e.jsxs(B,{size:"1",color:"gray",children:["Press ",e.jsx("b",{children:"Enter"})," to save"]})})]})]})},Vn=s=>{const[t,n]=u.useState(null),a=u.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setEditMessage:n,isOpen:t!==null,onClose:a}},Kn=({message:s,isOpen:t,onClose:n})=>ce()?e.jsx(re,{open:t,onOpenChange:n,children:e.jsx(ie,{className:le,children:s&&e.jsx(Je,{message:s,onClose:n})})}):e.jsx(Me,{open:t,onClose:n,children:e.jsx(De,{children:e.jsx("div",{className:"pb-24",children:s&&e.jsx(Je,{message:s,onClose:n})})})}),qn=(s,t,n)=>{var E,A;jt(),Fe();const a=ps(),{currentUser:r}=u.useContext(vs),[l,c]=pt(),o=l.get("message_id"),[d,f]=u.useState(o||null);u.useEffect(()=>{let m=null;return d&&(m=setTimeout(()=>{f(null)},4e3)),()=>{m&&clearTimeout(m)}},[d]);const{call:k,loading:N}=_e("raven.api.chat_stream.get_older_messages"),{call:v,loading:y}=_e("raven.api.chat_stream.get_newer_messages"),b=u.useRef(!1),S=(m="auto")=>{if(!t.current)return;requestAnimationFrame(()=>{t.current&&t.current.scrollTo({top:t.current.scrollHeight,behavior:m})});const i=setTimeout(()=>{t.current&&t.current.scrollTo({top:t.current.scrollHeight,behavior:m})},100),h=setTimeout(()=>{t.current&&t.current.scrollTo({top:t.current.scrollHeight,behavior:m})},500);return()=>{clearTimeout(i),clearTimeout(h)}},C=(m,i="smooth")=>{requestAnimationFrame(()=>{var j;(j=document.getElementById(`message-${m}`))==null||j.scrollIntoView({behavior:i,block:"center"})});const h=setTimeout(()=>{var j;(j=document.getElementById(`message-${m}`))==null||j.scrollIntoView({behavior:i,block:"center"})},100),g=setTimeout(()=>{var j;(j=document.getElementById(`message-${m}`))==null||j.scrollIntoView({behavior:i,block:"center"})},250);return()=>{clearTimeout(h),clearTimeout(g)}},{data:w,isLoading:M,error:T,mutate:I}=as("raven.api.chat_stream.get_messages",{channel_id:s,base_message:o||void 0},{path:`get_messages_for_channel_${s}`,baseMessage:o||void 0},{revalidateOnFocus:!!a,onSuccess:m=>{let i;return d?i=C(d):m.message.has_new_messages||(i=S(),b.current=!0),()=>{i&&i()}}});u.useEffect(()=>{if(!l.get("message_id"))return S()},[s]);const{call:P}=_e("raven.api.raven_channel_member.track_visit");u.useEffect(()=>()=>{b.current&&P({channel_id:s})},[s]),bt("Raven Channel",s!=null?s:"",()=>{}),me("message_created",m=>{m.channel_id===s&&I(i=>{var h,g,j;if(i&&i.message.has_new_messages===!1){const D=(h=i.message.messages)!=null?h:[],H=[...D];if(m.message_details){const p=D.findIndex(R=>R.name===m.message_details.name);p!==-1?H[p]=m.message_details:H.push(m.message_details)}return H.sort((p,R)=>new Date(R.creation).getTime()-new Date(p.creation).getTime()),{message:{messages:H,has_old_messages:(g=i.message.has_old_messages)!=null?g:!1,has_new_messages:(j=i.message.has_new_messages)!=null?j:!1}}}else return i},{revalidate:!1}).then(()=>{(w==null?void 0:w.message.has_new_messages)===!1&&t.current&&(t.current.scrollTop+t.current.clientHeight>=t.current.scrollHeight-100||m.message_details.owner===r)&&S("smooth")})}),me("message_edited",m=>{I(i=>m.message_id&&i?{message:{messages:i.message.messages.map(g=>g.name===m.message_id?x(x({},g),m.message_details):g),has_old_messages:i.message.has_old_messages,has_new_messages:i.message.has_new_messages}}:i,{revalidate:!1})}),me("message_deleted",m=>{I(i=>i&&{message:{messages:i.message.messages.filter(g=>g.name!==m.message_id),has_old_messages:i.message.has_old_messages,has_new_messages:i.message.has_new_messages}},{revalidate:!1})}),me("message_reacted",m=>{I(i=>m.message_id&&i?{message:{messages:i.message.messages.map(g=>g.name===m.message_id?z(x({},g),{message_reactions:m.reactions}):g),has_old_messages:i.message.has_old_messages,has_new_messages:i.message.has_new_messages}}:i,{revalidate:!1})}),me("message_saved",m=>{I(i=>m.message_id&&i?{message:{messages:i.message.messages.map(g=>g.name===m.message_id?z(x({},g),{_liked_by:m.liked_by}):g),has_old_messages:i.message.has_old_messages,has_new_messages:i.message.has_new_messages}}:i,{revalidate:!1})});const se=()=>{if(N||!(w!=null&&w.message.has_old_messages))return Promise.resolve();const m=t.current;if(!m)return Promise.resolve();const i=m.scrollHeight,h=m.scrollTop;return I(g=>{let j=null;return g&&g.message.messages.length>0&&g.message.has_old_messages&&(j=g.message.messages[g.message.messages.length-1],j)?k({channel_id:s,from_message:j.name}).then(D=>{var p,R,ve;return{message:{messages:[...g.message.messages,...(p=D==null?void 0:D.message.messages)!=null?p:[]],has_old_messages:(R=D==null?void 0:D.message.has_old_messages)!=null?R:!1,has_new_messages:(ve=g==null?void 0:g.message.has_new_messages)!=null?ve:!1}}}).catch(()=>g):g},{revalidate:!1}).then(()=>{requestAnimationFrame(()=>{if(m){const j=m.scrollHeight-i;m.scrollTop=h+j}})})},ee=()=>{if(y||!(w!=null&&w.message.has_new_messages)||d)return Promise.resolve();I(m=>{let i=null;return m&&m.message.messages.length>0&&m.message.has_new_messages&&(i=m.message.messages[0],i)?v({channel_id:s,from_message:i.name,limit:10}).then(h=>{var j,D,H;return{message:{messages:[...(j=h==null?void 0:h.message.messages)!=null?j:[],...m.message.messages],has_old_messages:(D=m==null?void 0:m.message.has_old_messages)!=null?D:!1,has_new_messages:(H=h==null?void 0:h.message.has_new_messages)!=null?H:!1}}}).catch(()=>m):m},{revalidate:!1}).then(m=>{(m==null?void 0:m.message.has_new_messages)===!1&&(b.current=!0,S("smooth"))})},Y=u.useMemo(()=>{var m;if(w){let i=(m=n==null?void 0:n.split(`
`))!=null?m:[];i=i.map(j=>j.trim());const h=[...w.message.messages],g=[];if(h.length>0){let j=h[h.length-1].creation.split(" ")[0],D=new Date(h[h.length-1].creation.split(".")[0]).getTime();g.push({creation:Ke(`${j} 00:00:00`).format("Do MMMM YYYY"),message_type:"date",name:j}),g.push(z(x({},h[h.length-1]),{is_continuation:0,is_pinned:i.includes(h[h.length-1].name)?1:0}));for(let H=h.length-2;H>=0;H--){const p=h[H],R=p.creation.split(" ")[0];let ve=new Date(p.creation.split(".")[0]).getTime();R!==j&&g.push({creation:Ke(`${R} 00:00:00`).format("Do MMMM YYYY"),message_type:"date",name:R});const Ds=p.is_bot_message?p.bot:p.owner,Ce=h[H+1],Is=Ce.message_type==="System"?null:Ce.is_bot_message?Ce.bot:Ce.owner;Ds!==Is?g.push(z(x({},p),{is_continuation:0,is_pinned:i.includes(p.name)?1:0})):ve-D>12e4?g.push(z(x({},p),{is_continuation:0,is_pinned:i.includes(p.name)?1:0})):g.push(z(x({},p),{is_continuation:1,is_pinned:i.includes(p.name)?1:0})),j=R,D=new Date(p.creation).getTime()}return g}else return[]}},[w,n]),te=m=>{var h;const i=Y==null?void 0:Y.findIndex(g=>g.name===m);i!==void 0&&i!==-1?((h=document.getElementById(`message-${m}`))==null||h.scrollIntoView({behavior:"smooth",block:"center"}),f(m)):(c({message_id:m}),f(m))},ne=()=>{c({})};return{messages:Y,hasOlderMessages:(E=w==null?void 0:w.message.has_old_messages)!=null?E:!1,hasNewMessages:(A=w==null?void 0:w.message.has_new_messages)!=null?A:!1,loadingOlderMessages:N,isLoading:M,error:T,loadNewerMessages:ee,loadOlderMessages:se,scrollToMessage:te,highlightedMessage:d,goToLatestMessages:ne}},Wn=()=>e.jsxs("div",{className:"py-4 animate-fadein",children:[e.jsx(be,{isContinuation:!0,isShortText:!0}),e.jsx(be,{isContinuation:!1,isImage:!0}),e.jsx(be,{isContinuation:!1,isShortText:!0}),e.jsx(be,{isContinuation:!0,isImage:!0}),e.jsx(be,{isContinuation:!1,isLongText:!0})]}),be=({isContinuation:s,isShortText:t,isImage:n,isLongText:a})=>e.jsxs("div",{className:"flex items-start gap-3 p-2",children:[e.jsx("div",{className:"w-8 flex items-center",children:s?e.jsx("div",{}):e.jsx(Yn,{})}),e.jsxs("div",{className:"flex flex-col gap-1.5 justify-center",children:[!s&&e.jsxs("div",{className:"flex items-center gap-2 -mt-1",children:[e.jsx(G,{className:"rounded-md w-32 h-5"}),e.jsx(he,{orientation:"vertical"}),e.jsx(G,{className:"rounded-md w-16 h-5"})]}),t&&e.jsxs("div",{className:"gap-1 flex flex-col",children:[e.jsx(G,{className:"rounded-md w-48 h-5"}),e.jsx(G,{className:"rounded-md w-64 h-5"})]}),a&&e.jsxs("div",{className:"gap-1 flex flex-col",children:[e.jsx(G,{className:"rounded-md w-80 h-5"}),e.jsx(G,{className:"rounded-md w-64 h-5"}),e.jsx(G,{className:"rounded-md w-72 h-5"}),e.jsx(G,{className:"rounded-md w-48 h-5"})]}),n&&e.jsx("div",{className:"gap-1 flex flex-col",children:e.jsx(G,{className:"rounded-md w-96 h-64"})})]})]}),Yn=()=>e.jsx(G,{className:"w-8 h-8 rounded-md"});var Be=new Map,Se=new WeakMap,Ze=0,Gn=void 0;function Jn(s){return s?(Se.has(s)||(Ze+=1,Se.set(s,Ze.toString())),Se.get(s)):"0"}function Zn(s){return Object.keys(s).sort().filter(t=>s[t]!==void 0).map(t=>`${t}_${t==="root"?Jn(s.root):s[t]}`).toString()}function Qn(s){const t=Zn(s);let n=Be.get(t);if(!n){const a=new Map;let r;const l=new IntersectionObserver(c=>{c.forEach(o=>{var d;const f=o.isIntersecting&&r.some(k=>o.intersectionRatio>=k);s.trackVisibility&&typeof o.isVisible=="undefined"&&(o.isVisible=f),(d=a.get(o.target))==null||d.forEach(k=>{k(f,o)})})},s);r=l.thresholds||(Array.isArray(s.threshold)?s.threshold:[s.threshold||0]),n={id:t,observer:l,elements:a},Be.set(t,n)}return n}function Xn(s,t,n={},a=Gn){if(typeof window.IntersectionObserver=="undefined"&&a!==void 0){const d=s.getBoundingClientRect();return t(a,{isIntersecting:a,target:s,intersectionRatio:typeof n.threshold=="number"?n.threshold:0,time:0,boundingClientRect:d,intersectionRect:d,rootBounds:d}),()=>{}}const{id:r,observer:l,elements:c}=Qn(n),o=c.get(s)||[];return c.has(s)||c.set(s,o),o.push(t),l.observe(s),function(){o.splice(o.indexOf(t),1),o.length===0&&(c.delete(s),l.unobserve(s)),c.size===0&&(l.disconnect(),Be.delete(r))}}function Qe({threshold:s,delay:t,trackVisibility:n,rootMargin:a,root:r,triggerOnce:l,skip:c,initialInView:o,fallbackInView:d,onChange:f}={}){var k;const[N,v]=u.useState(null),y=u.useRef(f),[b,S]=u.useState({inView:!!o,entry:void 0});y.current=f,u.useEffect(()=>{if(c||!N)return;let T;return T=Xn(N,(I,P)=>{S({inView:I,entry:P}),y.current&&y.current(I,P),P.isIntersecting&&l&&T&&(T(),T=void 0)},{root:r,rootMargin:a,threshold:s,trackVisibility:n,delay:t},d),()=>{T&&T()}},[Array.isArray(s)?s.toString():s,N,r,a,l,c,n,d,t]);const C=(k=b.entry)==null?void 0:k.target,w=u.useRef(void 0);!N&&C&&!l&&!c&&w.current!==C&&(w.current=C,S({inView:!!o,entry:void 0}));const M=[v,b.inView,b.entry];return M.ref=M[0],M.inView=M[1],M.entry=M[2],M}const ea=r=>{var l=r,{selectedOptions:s,setSelectedOptions:t,label:n="Select Users / Channels"}=l,a=K(l,["selectedOptions","setSelectedOptions","label"]);const c=u.useContext(fs),o=u.useContext(xs),d=[...c.enabledUsers,...o.channels],f=ce();function k(v,y){const b=y.toLowerCase();return d.filter(S=>{const C=v.find(w=>w.name===S.name);return"full_name"in S?!C&&(S.full_name.toLowerCase().includes(b)||S.name.toLowerCase().includes(b)):!C&&(S.channel_name.toLowerCase().includes(b)||S.name.toLowerCase().includes(b))})}function N({selectedOptions:v,setSelectedOptions:y}){const[b,S]=u.useState(""),C=u.useMemo(()=>k(v,b),[v,b]),{getSelectedItemProps:w,getDropdownProps:M,removeSelectedItem:T}=pe({selectedItems:v,onStateChange({selectedItems:E,type:A}){switch(A){case pe.stateChangeTypes.SelectedItemKeyDownBackspace:case pe.stateChangeTypes.SelectedItemKeyDownDelete:case pe.stateChangeTypes.DropdownKeyDownBackspace:case pe.stateChangeTypes.FunctionRemoveSelectedItem:y(E!=null?E:[]);break}}}),{isOpen:I,getLabelProps:P,getMenuProps:se,getInputProps:ee,highlightedIndex:Y,getItemProps:te,selectedItem:ne}=ae({items:C,itemToString(E){return E?E.name:""},defaultHighlightedIndex:0,selectedItem:null,inputValue:b,stateReducer(E,A){const{changes:m,type:i}=A;switch(i){case ae.stateChangeTypes.InputKeyDownEnter:case ae.stateChangeTypes.ItemClick:return z(x({},m),{isOpen:!0,highlightedIndex:0});default:return m}},onStateChange({inputValue:E,type:A,selectedItem:m}){switch(A){case ae.stateChangeTypes.InputKeyDownEnter:case ae.stateChangeTypes.ItemClick:case ae.stateChangeTypes.InputBlur:m&&(y([...v,m]),S(""));break;case ae.stateChangeTypes.InputChange:S(E!=null?E:"");break}}});return e.jsxs("div",{className:"w-full",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsx(yt,z(x({className:"w-fit"},P()),{children:n})),e.jsx(_t,x({placeholder:"Type a name...",className:"w-full",autoFocus:f},ee(M()))),e.jsx("div",{className:"inline-flex gap-1 p-1 items-center flex-wrap",children:v.map(function(A,m){var i;return"channel_name"in A?e.jsxs("span",z(x({className:"rt-Button rt-BaseButton rt-variant-surface rt-r-size-2 flex items-center"},w({selectedItem:A,index:m})),{children:[e.jsx(Ae,{type:A.type,size:"14"}),e.jsx(B,{size:"2",children:A.channel_name}),e.jsx("span",{className:"cursor-pointer",onClick:h=>{h.stopPropagation(),T(A)},children:"âœ•"})]}),`selected-item-${m}`):e.jsxs("span",z(x({className:"rt-Button rt-BaseButton rt-variant-surface rt-r-size-2 flex items-center"},w({selectedItem:A,index:m})),{children:[e.jsx(Ne,{src:(i=A.user_image)!=null?i:"",alt:A.full_name,size:"1",variant:"solid",color:"gray"}),e.jsx(B,{size:"2",children:A.full_name}),e.jsx("span",{className:"cursor-pointer",onClick:h=>{h.stopPropagation(),T(A)},children:"âœ•"})]}),`selected-item-${m}`)})})]}),e.jsx("ul",z(x({className:`sm:w-[550px] w-[24rem] absolute bg-background rounded-b-md mt-1 shadow-md z-[9999] max-h-96 overflow-scroll p-0 ${!(I&&C.length)&&"hidden"}`},se()),{children:I&&C.map((E,A)=>{var m;return e.jsx("li",z(x({className:Z(Y===A&&"bg-accent-4",ne===E&&"font-bold","py-2 px-3 shadow-sm flex gap-2 items-center")},te({item:E,index:A})),{children:"channel_name"in E?e.jsxs(ye,{justify:"between",width:"100%",children:[e.jsxs(ye,{gap:"1",align:"center",children:[e.jsx(Ae,{type:E.type,size:"14"}),e.jsx(B,{as:"span",weight:"medium",size:"2",children:E.channel_name})]}),e.jsxs(ye,{gap:"1",align:"center",children:[e.jsx(wt,{color:"gray"}),e.jsx(B,{size:"1",color:"gray",children:E.workspace})]})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ne,{src:(m=E.user_image)!=null?m:"",alt:E.full_name,size:"2"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx(B,{as:"span",weight:"medium",size:"2",children:E.full_name}),e.jsx(B,{as:"span",size:"1",children:E.name})]})]})}),`${E.name}`)})}))]})}return e.jsx(N,{selectedOptions:s,setSelectedOptions:t})},Xe=({onClose:s,message:t})=>{var N;const n=Oe({defaultValues:{selected_options:null,message:t}}),{handleSubmit:a,reset:r,control:l}=n,{call:c,error:o,loading:d}=_e("raven.api.raven_message.forward_message"),f=v=>{v.selected_options&&v.selected_options.length>0&&c({message_receivers:v.selected_options,forwarded_message:v.message}).then(()=>{X.success("Message forwarded successfully!"),k()}).catch(()=>{X.error("Failed to forward message")})},k=()=>{r(),s()};return e.jsx(Re,z(x({},n),{children:e.jsxs("form",{onSubmit:a(f),children:[e.jsxs(_,{justify:"between",children:[e.jsx(xe,{children:"Forward Message"}),e.jsx(ws,{children:e.jsx(je,{children:"Forward message to a user or channel"})}),e.jsx(ge,{onClick:k,children:e.jsx(L,{size:"1",variant:"soft",color:"gray",children:e.jsx($e,{size:"18"})})})]}),e.jsxs(_,{gap:"2",direction:"column",width:"100%",children:[e.jsx(oe,{error:o}),e.jsx(U,{width:"100%",children:e.jsxs(_,{direction:"column",gap:"2",children:[e.jsx(u.Suspense,{fallback:e.jsx(V,{}),children:e.jsx(vt,{control:l,name:"selected_options",rules:{validate:v=>v&&v.length>0?!0:"Please select at least one member"},render:({field:{onChange:v,value:y}})=>e.jsx(ea,{setSelectedOptions:v,selectedOptions:y!=null?y:[]})})}),e.jsx(we,{children:(N=n.formState.errors.selected_options)==null?void 0:N.message})]})})]}),e.jsxs(_,{gap:"3",mt:"6",justify:"end",align:"center",children:[e.jsx(ge,{disabled:d,children:e.jsx(W,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsxs(W,{type:"submit",disabled:d,children:[d&&e.jsx(V,{className:"text-white"}),d?"Sending":"Send"]})]})]})}))},sa=s=>{const[t,n]=u.useState(null),a=u.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setForwardMessage:n,isOpen:t!==null,onClose:a}},ta=({message:s,isOpen:t,onClose:n})=>ce()?e.jsx(re,{open:t,onOpenChange:n,children:e.jsx(ie,{className:"static",children:s&&e.jsx(Xe,{message:s,onClose:n})})}):e.jsx(Me,{open:t,onClose:n,children:e.jsx(De,{children:e.jsx("div",{className:"pb-24",children:s&&e.jsx(Xe,{message:s,onClose:n})})})}),es=({onClose:s,message:t})=>{var w,M;const n=Oe({defaultValues:{}}),{handleSubmit:a,reset:r,watch:l}=n,{call:c}=u.useContext(Ee),[o,d]=u.useState(!1),[f,k]=u.useState(null),{recentlyUsedDoctypes:N,addRecentlyUsedDocType:v}=Ns(),y=T=>{if(t.file){v(T.doctype),d(!0);const I=t.file.split("?")[0];c.get("frappe.client.get_value",{doctype:"File",filters:{file_url:I,attached_to_doctype:"Raven Message",attached_to_name:t.name,attached_to_field:"file"},fieldname:["name"]}).then(P=>{P.message&&c.post("upload_file",{doctype:T.doctype,docname:T.docname,library_file_name:P.message.name})}).then(()=>{X.success(`File attached to ${T.doctype} - ${T.docname}`),b()}).catch(P=>{k(P),X.error("Failed to attach file")}).finally(()=>{d(!1)})}},b=()=>{r(),s()},S=l("doctype"),C=()=>{n.setValue("docname","")};return e.jsx(Re,z(x({},n),{children:e.jsxs("form",{onSubmit:a(y),children:[e.jsxs(_,{justify:"between",children:[e.jsx(xe,{children:"Attach File to Document"}),e.jsx(je,{hidden:!0,children:"Attach the file to a document"}),e.jsx(ge,{onClick:b,children:e.jsx(L,{size:"1",variant:"soft",color:"gray",children:e.jsx($e,{size:"18"})})})]}),e.jsxs(_,{gap:"2",direction:"column",width:"100%",children:[e.jsx(oe,{error:f}),e.jsxs(bs,{children:[e.jsx(ys,{children:e.jsx(Ct,{ext:kt(t.file)})}),e.jsx(_s,{children:e.jsx(St,{href:t.file,children:Nt(t.file)})})]}),e.jsx(U,{width:"100%",children:e.jsxs(_,{direction:"column",gap:"2",children:[e.jsx(Te,{name:"doctype",label:"Document Type",autofocus:!0,suggestedItems:N,rules:{required:"Document Type is required",onChange:C},filters:[["issingle","=",0],["istable","=",0]],doctype:"DocType"}),e.jsx(we,{children:(w=n.formState.errors.doctype)==null?void 0:w.message})]})}),S&&e.jsx(U,{width:"100%",children:e.jsxs(_,{direction:"column",gap:"2",children:[e.jsx(Te,{name:"docname",label:"Document Name",placeholder:"Select a document",disabled:!S,rules:{required:"Document Name is required"},doctype:S}),e.jsx(we,{children:(M=n.formState.errors.docname)==null?void 0:M.message})]})})]}),e.jsxs(_,{gap:"3",mt:"6",justify:"end",align:"center",children:[e.jsx(ge,{disabled:o,children:e.jsx(W,{variant:"soft",color:"gray",children:"Cancel"})}),e.jsxs(W,{type:"submit",disabled:o,children:[o&&e.jsx(V,{className:"text-white"}),"Attach"]})]})]})}))},na=s=>{const[t,n]=u.useState(null),a=u.useCallback(()=>{n(null),s==null||s()},[s]);return{message:t,setAttachDocument:n,isOpen:t!==null,onClose:a}},aa=({message:s,isOpen:t,onClose:n})=>ce()?e.jsx(re,{open:t,onOpenChange:n,children:e.jsx(ie,{className:Z(le,"static"),children:s&&e.jsx(es,{message:s,onClose:n})})}):e.jsx(Me,{open:t,onClose:n,children:e.jsx(De,{children:e.jsx("div",{className:"pb-24",children:s&&e.jsx(es,{message:s,onClose:n})})})}),ss=({reactions:s})=>{const t=u.useMemo(()=>s.flatMap(({reaction:n,users:a,is_custom:r,emoji_name:l})=>a.map(c=>({user:c,reaction:n,is_custom:r,emoji_name:l}))),[s]);return e.jsx(e.Fragment,{children:e.jsx(Tt,{defaultValue:"All",children:e.jsxs(_,{direction:"column",gap:"4",children:[e.jsxs(Et,{children:[e.jsx(ts,{emojiSrc:"All",emojiName:"All"}),s.map(n=>e.jsx(ts,{emojiSrc:n.reaction,isCustom:n.is_custom,emojiName:n.emoji_name,count:n.count},n.reaction))]}),e.jsxs(U,{children:[e.jsx(qe,{value:"All",children:e.jsx(ns,{users:t})}),s.map(n=>e.jsx(qe,{value:n.reaction,children:e.jsx(ns,{users:n.users.map(a=>({user:a,reaction:n.reaction,is_custom:n.is_custom,emoji_name:n.emoji_name}))})},n.reaction))]})]})})})},ts=({emojiSrc:s,count:t,emojiName:n,isCustom:a=!1})=>e.jsx(Mt,{value:s,className:"text-gray-11",title:n,children:e.jsxs(_,{gap:"2",align:"center",justify:"center",children:[a?e.jsx("img",{src:s,alt:n,className:"w-[1.2rem] h-[1.2rem] object-contain object-center"}):n==="All"?e.jsx(B,{size:"3",children:"All"}):e.jsx(B,{size:"3",className:"w-[1.2rem] h-[1.2rem]",children:e.jsx("em-emoji",{native:n,set:"apple"})}),t&&e.jsx(B,{children:t})]})}),ns=({users:s})=>e.jsx(U,{className:"overflow-hidden overflow-y-scroll h-[50vh] sm:h-64",children:e.jsx(_,{direction:"column",gap:"2",children:e.jsx(_,{direction:"column",children:s.map((t,n)=>e.jsx(ra,{user:t.user,reaction:t.reaction,is_custom:t.is_custom,emoji_name:t.emoji_name},n))})})}),ra=({user:s,reaction:t,is_custom:n,emoji_name:a})=>{var c,o;const r=Dt(s),l=(c=r==null?void 0:r.full_name)!=null?c:s;return e.jsx(U,{className:"hover:bg-slate-3 rounded-md",children:e.jsxs(_,{align:"center",justify:"between",children:[e.jsxs(_,{className:"p-2",gap:"3",align:"center",children:[e.jsx(Ne,{src:(o=r==null?void 0:r.user_image)!=null?o:"",alt:l,size:"2"}),e.jsx(B,{size:"2",weight:"medium",children:l})]}),n?e.jsx("img",{src:t,alt:a,title:a,className:"mr-3 w-[1.4rem] h-[1.4rem] object-contain object-center"}):e.jsx(B,{className:"pr-3 h-[1.4rem] w-[1.4rem]",size:"3",weight:"medium",children:e.jsx("em-emoji",{native:a,size:"1.2em",set:"apple"})})]})})},ia=s=>{const[t,n]=u.useState(null),a=t==null?void 0:t.message_reactions,r=u.useMemo(()=>{const c=JSON.parse(a!=null?a:"{}");return Object.entries(c).map(([o,d])=>z(x({},d),{emoji_name:o}))},[a]),l=u.useCallback(()=>{n(null),s==null||s()},[s]);return{reactions:r,message:t,onClose:l,isOpen:t!==null,setReactionMessage:n}},la=a=>{var r=a,{isOpen:s,onClose:t}=r,n=K(r,["isOpen","onClose"]);return ce()?e.jsx(re,{open:s,onOpenChange:t,children:e.jsx(ie,{className:`${le} w-[450px]`,children:e.jsx(ss,x({},n))})}):e.jsx(Me,{open:s,onClose:t,children:e.jsx(De,{children:e.jsx("div",{className:"pb-12",children:e.jsx(ss,x({},n))})})})},ca=({message:s})=>e.jsxs(_,{align:"center",gap:"2",id:`message-${s.name}`,className:"pl-1 py-2.5",children:[e.jsx(nn,{timestamp:s.creation}),e.jsx(B,{as:"span",color:"gray",className:"pl-1.5",size:"1",children:s.text})]}),va=u.forwardRef(({channelID:s,replyToMessage:t,showThreadButton:n=!0,pinnedMessagesString:a,scrollRef:r,onModalClose:l},c)=>{const{messages:o,hasOlderMessages:d,loadOlderMessages:f,goToLatestMessages:k,hasNewMessages:N,error:v,loadNewerMessages:y,isLoading:b,highlightedMessage:S,scrollToMessage:C}=qn(s,r,a),h=$n(l),{setDeleteMessage:w}=h,M=K(h,["setDeleteMessage"]),g=Vn(l),{setEditMessage:T}=g,I=K(g,["setEditMessage"]),j=sa(l),{setForwardMessage:P}=j,se=K(j,["setForwardMessage"]),D=na(l),{setAttachDocument:ee}=D,Y=K(D,["setAttachDocument"]),H=ia(l),{setReactionMessage:te}=H,ne=K(H,["setReactionMessage"]),E=p=>{C(p)},{name:A}=It();u.useImperativeHandle(c,()=>({onUpArrow:()=>{if(o&&o.length>0){const p=o[o.length-1];p.message_type==="Text"&&p.owner===A&&!p.is_bot_message&&T(p)}}}));const{ref:m}=Qe({fallbackInView:!0,initialInView:!1,skip:!d,onChange:p=>q(void 0,null,function*(){p&&d&&(yield f())})}),{ref:i}=Qe({fallbackInView:!0,skip:!N,initialInView:!1,onChange:p=>{p&&N&&y()}});return u.useEffect(()=>{if(!r.current)return;const p=new ResizeObserver(()=>{const R=r.current;R&&R.scrollTop+R.clientHeight>=R.scrollHeight-100&&requestAnimationFrame(()=>{R.scrollTo({top:R.scrollHeight,behavior:"instant"})})});return p.observe(r.current),()=>{p.disconnect()}},[]),e.jsxs("div",{className:"relative h-full flex flex-col overflow-y-auto pb-16 sm:pb-0",ref:r,children:[e.jsx("div",{ref:m,children:d&&!b&&e.jsx("div",{className:"flex w-full min-h-8 pb-4 justify-center items-center",children:e.jsx(V,{})})}),!b&&!d&&e.jsx(cn,{channelID:s!=null?s:""}),b&&e.jsx(Wn,{}),v&&e.jsx(oe,{error:v}),e.jsx("div",{className:Z("flex flex-col pb-4 z-50 transition-opacity duration-400 ease-ease-out-cubic",b?"opacity-0":"opacity-100"),children:o==null?void 0:o.map(p=>p.message_type==="date"?e.jsx(on,{id:`date-${p.creation}`,className:"p-2 z-10 relative",children:p.creation},`date-${p.creation}`):p.message_type==="System"?e.jsx(ca,{message:p},`${p.name}_${p.modified}`):e.jsx("div",{id:`message-${p.name}`,children:e.jsx("div",{className:"w-full overflow-x-clip overflow-y-visible text-ellipsis",children:e.jsx(an,{message:p,isHighlighted:S===p.name,onReplyMessageClick:E,setEditMessage:T,replyToMessage:t,forwardMessage:P,showThreadButton:n,onAttachDocument:ee,setDeleteMessage:w,setReactionMessage:te})})},`${p.name}_${p.modified}`))}),N&&e.jsx("div",{ref:i,children:e.jsx("div",{className:"flex w-full min-h-8 pb-4 justify-center items-center",children:e.jsx(V,{})})}),N&&e.jsx("div",{className:"fixed bottom-36 z-50 right-5",children:e.jsxs(W,{className:"shadow-lg",onClick:k,children:["Scroll to new messages",e.jsx(At,{size:18})]})}),e.jsx(Hn,x({},M)),e.jsx(Kn,x({},I)),e.jsx(ta,x({},se)),e.jsx(aa,x({},Y)),e.jsx(la,x({},ne))]})}),Ca=({channelData:s,user:t})=>{const{mutate:n}=zt(),{threadID:a}=js(),{createDoc:r,error:l,loading:c}=cs(),o=()=>q(void 0,null,function*(){return r("Raven Channel Member",{channel_id:s?s==null?void 0:s.name:a,user_id:t}).then(()=>{n(["channel_members",s?s.name:a])})});return e.jsx(U,{children:e.jsxs(_,{direction:"column",align:"center",gap:s?"3":"2",className:"border border-gray-6 rounded-md bg-surface animate-fadein sm:mb-0 mb-2",p:s?"4":"3",children:[e.jsx(oe,{error:l}),e.jsxs(B,{as:"span",size:"2",children:["You are not a member of this ",s?"channel":"thread","."]}),e.jsxs(W,{onClick:o,size:s?"2":"1",disabled:c,children:[c&&e.jsx(V,{className:"text-white"}),c?"Joining":e.jsxs("span",{className:"inline-flex gap-1 not-cal font-medium",children:["Join ",s?`${s==null?void 0:s.channel_name}`:"Conversation"]})]})]})})},oa=s=>{const{socket:t}=u.useContext(Ee),[n,a]=u.useState([]);return u.useEffect(()=>{t&&(t.emit("raven_channel_get_typers",s),t.io.on("reconnect",()=>{t.emit("raven_channel_get_typers",s)}))},[s]),me("raven_channel_typers",r=>{r.channel===s&&a(r.users)}),n},ka=s=>{const[t,n]=u.useState(0),a=u.useRef(!1),{socket:r}=u.useContext(Ee),l=u.useCallback(()=>{r==null||r.emit("raven_channel_typing",s)},[s]),c=u.useCallback(()=>{r==null||r.emit("raven_channel_typing_stopped",s)},[s]),o=u.useCallback(()=>{a.current||(a.current=!0,n(f=>f+1),l())},[l]);return u.useEffect(()=>{let f;return t>0&&(f=setTimeout(()=>{a.current=!1,n(0),c()},1e4)),()=>{clearTimeout(f)}},[t,c]),u.useEffect(()=>()=>{c()},[c]),{stopTyping:u.useCallback(()=>{c(),a.current=!1,n(0)},[c]),onUserType:o}},Sa=({channel:s})=>{const t=oa(s),n=dn(),{currentUser:a}=u.useContext(vs),r=u.useMemo(()=>{const l=t.filter(c=>c!==a).map(c=>{var o,d,f,k;return(k=(f=(o=n[c])==null?void 0:o.first_name)!=null?f:(d=n[c])==null?void 0:d.full_name)!=null?k:c});return l.length===0?"":l.length===1?l[0]+" is typing...":l.length===2?l[0]+" and "+l[1]+" are typing...":l.length===3?l[0]+", "+l[1]+" and 1 other are typing...":l[0]+", "+l[1]+" and "+(l.length-2)+" others are typing..."},[t,n,a]);return r===""?null:e.jsxs(ye,{className:"gap-1.5 pl-0.5 pt-1 relative sm:bottom-0 bottom-16 sm:pb-0 pb-2",align:"center",children:[e.jsxs("div",{className:"flex items-center space-x-1 -mb-0.5",children:[e.jsx("div",{className:"w-1.5 h-1.5 bg-gray-12 rounded-full animate-pulse-bounce",style:{animationDelay:"0ms"}}),e.jsx("div",{className:"w-1.5 h-1.5 bg-gray-12 rounded-full animate-pulse-bounce",style:{animationDelay:"150ms"}}),e.jsx("div",{className:"w-1.5 h-1.5 bg-gray-12 rounded-full animate-pulse-bounce",style:{animationDelay:"300ms"}})]}),e.jsx(B,{size:"1",as:"span",children:r})]})};export{va as C,wa as F,pn as H,Ca as J,Sa as T,ya as a,_a as b,Fn as c,ka as u};
